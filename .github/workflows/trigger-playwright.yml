name: trigger-tests
on:
  # Permite el disparo manual (usado para debugging)
  workflow_dispatch:
    inputs:
      sha:
        description: 'SHA del commit a testear (usar solo en ejecucion manual)'
        required: true
        default: ${{ github.sha }}
      check_run_id:
        description: 'ID del Check Run a actualizar (Opcional)'
        required: false
        default: ''
        
  # Se dispara al hacer PUSH/MERGE a main.
  push:
    branches: [ main ]
    
  # Se dispara cuando hay una Pull Request (PR) a main. ESTO SERÁ EL BLOQUEADOR.
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ] # Al abrir, actualizar o reabrir la PR

jobs:
  trigger-tests:
    runs-on: ubuntu-latest
    
    # Define el SHA del commit a testear, priorizando el de la PR
    env:
      COMMIT_SHA: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || (github.event_name == 'workflow_dispatch' && github.event.inputs.sha || github.sha) }}

    steps:
      # 1. Crear un Check Run 'Pending' en el repositorio A (el que contiene la PR).
      - name: Iniciar Check Run en Repo Origen
        if: github.event_name == 'pull_request'
        id: create_check
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'playwright-tests-cross-repo', # <-- NOMBRE DEL CHECK QUE USARÁS PARA BLOQUEAR LA RAMA
              head_sha: process.env.COMMIT_SHA,
              status: 'in_progress',
              output: {
                title: 'Tests de Regresión en Curso (Repo Externo)',
                summary: 'Lanzando tests en el repositorio de Playwright. Por favor, espera a que termine para hacer el merge.',
              }
            });
            // Guarda el ID del Check Run para que el otro repo sepa qué actualizar
            core.setOutput('check_run_id', response.data.id);
          # Usamos el GITHUB_TOKEN automático para acciones dentro del mismo repositorio
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          COMMIT_SHA: ${{ env.COMMIT_SHA }}
          
      # 2. Disparar Tests en Repo Playwright (Repo B)
      - name: Disparar Tests en Repo Playwright (Repo B)
        run: |
          REPO_DESTINO="hgarnacho2/playwright-bdd-ts-tfm"
          
          PAYLOAD='{
            "event_type": "run_regression_tests",
            "client_payload": {
              "repo_origen": "${{ github.repository }}",
              "sha_origen": "${{ env.COMMIT_SHA }}",
              "check_run_id": "${{ steps.create_check.outputs.check_run_id || github.event.inputs.check_run_id || '' }}",
              "check_name": "playwright-tests-cross-repo"
            }
          }'
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.PLAYWRIGHT_AUTO }}" \
            https://api.github.com/repos/${REPO_DESTINO}/dispatches \
            -d "$PAYLOAD"
        env:
          COMMIT_SHA: ${{ env.COMMIT_SHA }}

          
